## do_fork

通过发起系统调用执行`do_fork`函数。用于创建并唤醒进程，可以通过`sys_fork`或者`kernel_thread`调用。

+ 初始化一个新进程
+ 为新进程分配内核栈空间
+ 为新进程分配新的虚拟内存或与其他进程共享虚拟内存
+ 获取原进程的上下文与中断帧，设置当前进程的上下文与中断帧
+ 将新进程插入哈希表和链表中
+ 唤醒新进程
+ 返回进程`id`

## do_execve

通过发起系统调用执行`do_execve`函数。用于创建用户空间，加载用户程序，可以通过`sys_exec`调用。

+ 回收当前进程的虚拟内存空间
+ 为当前进程分配新的虚拟内存空间并加载应用程序

execve系统调用用于在当前进程中执行一个新的程序。

获取当前进程的内存管理结构

检查用户空间是否可读

限制名称长度防溢出

复制传入的程序名称到本地缓存区

如果当前进程有内存管理结果

- 切换回内核页表
- 如果内存管理结果引用计数为0，清理内存资源
- 将当前进程的内存管理结构设为NULL

调用load_icode函数加载并执行新程序

设置进程的名称为新程序的名称

## copy_range

用于将一个地址范围内的页从一个页目录（`from`）复制到另一个页目录（`to`）

断言起始和结束地址是页对齐的，并且地址范围在用户空间内

逐页复制内容

- 调用 get_pte 函数根据地址 start 找到进程 A 的页表项 ptep
- 如果 ptep 为空，向下对齐地址并继续下一页
- 调用 get_pte 函数根据地址 start 找到进程 B 的页表项 nptep
- 如果 nptep 为空，就分配一个页表
- 获取权限信息（PTE_USER）并获取进程 A 的页
- 为进程 B 分配一个新的页
- 使用 memcpy 复制页的内容
- 将新的页插入到进程 B 的页表中

移动到下一页

此函数的目的是在两个页目录之间复制地址范围内的所有页。如果目标页表中的页表项不存在，它会为目标页表分配一个新的页表，并为每一页从源页表中复制内容。函数返回 0 表示成功，否则返回错误码。

## copyonwrite

+ 在`fork`时，将父进程的所有页表项设置为只读，在新进程的结构中只复制栈和虚拟内存的页表，不为其分配新的页
+ 切换到子进程执行时，如果子进程需要修改一页的内容，会访问页表，由于该页不允许被修改，所以会引发异常
+ 异常处理部分，遇到该类异常，重新分配一块空间，将访问的页面复制进去，更新子进程的页表项




COW（Copy-On-Write）是一种内存管理技术，通常用于优化进程之间共享内存页面的开销。在COW中，当多个进程或进程共享相同的物理内存页面时，这些进程会共享同一块物理内存，直到其中一个进程尝试写入该内存。

具体来说，COW的工作流程如下：

1. **共享相同的物理内存：** 多个进程或进程被允许共享同一块物理内存，通常是在进行进程复制或进程创建时发生。
2. **标记页面为只读：** 操作系统将这些共享的内存页面标记为只读。这样，只有当某个进程尝试写入这个页面时，才会触发特殊的处理。
3. **写入尝试触发复制：** 当某个进程尝试写入一个被标记为只读的内存页面时，操作系统会触发COW机制。此时，系统会创建该进程的私有副本，将修改写入到私有副本中，而不是直接修改原始共享的页面。
4. **更新映射：** 操作系统更新进程的地址空间映射，使其指向新创建的私有副本。

通过这种方式，COW可以有效地减少在进程间共享数据时的内存开销。只有在写入尝试发生时，才会复制原始数据。这使得多个进程可以共享相同的内存，而不会立即产生额外的内存拷贝。

COW的应用场景包括进程复制（fork）和进程创建，以及在虚拟内存系统中。在这些情况下，多个进程或进程可以共享相同的代码段和只读数据，而只有在其中一个进程或进程尝试修改数据时才会创建副本。这提高了内存的利用效率和性能。

## load_icode

加载文件

先检查当前进程的内存管理是否为空（mm）

- 为当前进程创建新的内存管理结构mm

- 创建新页目录表PDT，并将mm->pgdir设置为页目录表的内核虚拟地址

- 复制TEXT/DATA部分，将二进制文件BSS部分构建到进程的内存空间

  1.获取二进制程序文件头ELF

  2.程序段头入口ELF

  3.验证程序是否有效

  4.查找每个程序段头

  5.调用mm_map设置新的VMA（ph->p_va,ph->p_memsz)

  6.分配内存，将每个程序段内容从二进制文件复制到进程内存

  6.1复制程序的TEXT/DATA

  6.2构建程序的BSS

- 构建用户栈内存

- 设置当前进程的mm，sr3，并设置CR3寄存器=页目录的物理地址

- 为用户环境设置trapframe

将`sp`设置为栈顶，`epc`设置为文件的入口地址，`sstatus`的`SPP`位清零，代表异常来自用户态，之后需要返回用户态；`SPIE`位清零，表示不启用中断。

